<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>The Collective Canvas â€” Place</title>

<style>
html, body {
  margin: 0;
  background: #0b0b0b;
  overflow: hidden;
  font-family: Inter, sans-serif;
}

/* ================= UI ================= */
#ui {
  position: fixed;
  top: 24px;
  left: 24px;
  z-index: 20;
  background: rgba(0,0,0,0.65);
  border: 1px solid rgba(255,255,255,0.25);
  padding: 18px;
  border-radius: 14px;
  color: white;
  backdrop-filter: blur(10px);
}

#ui h3 {
  margin: 0 0 8px;
  font-size: 11px;
  letter-spacing: 1px;
  opacity: 0.7;
  text-transform: uppercase;
}

#remaining {
  font-size: 22px;
  margin-bottom: 14px;
  transition: transform 0.25s ease;
}

#remaining.bump {
  transform: scale(1.15);
}

#colorPicker {
  width: 56px;
  height: 56px;
  border-radius: 8px;
  border: 1px solid rgba(255,255,255,0.6);
  background: none;
  cursor: pointer;
}

#activeColor {
  margin-top: 8px;
  width: 56px;
  height: 10px;
  border-radius: 5px;
}

/* Validation button */
#validate {
  margin-top: 16px;
  padding: 10px 18px;
  border: 1px solid rgba(255,255,255,0.7);
  background: transparent;
  color: white;
  font-size: 13px;
  cursor: pointer;
  display: none;
  opacity: 0;
  transform: translateY(6px);
  transition: opacity 0.25s ease, transform 0.25s ease;
}
#validate.show {
  display: block;
  opacity: 1;
  transform: translateY(0);
}
#validate:hover {
  background: white;
  color: black;
}

/* ================= CANVAS ================= */
#container {
  position: absolute;
  inset: 0;
  display: flex;
  align-items: center;
  justify-content: center;
}

#main {
  image-rendering: pixelated;
  background: #000;
  transform: scale(0.75);
}

/* ================= LOUPE ================= */
#loupe {
  position: fixed;
  width: 140px;
  height: 140px;
  border-radius: 50%;
  border: 1px solid rgba(255,255,255,0.8);
  pointer-events: none;
  overflow: hidden;
  z-index: 15;
  display: none;
}

#zoom {
  image-rendering: pixelated;
}

/* ultra-fin reticle */
#loupe::after {
  content: "";
  position: absolute;
  inset: 0;
  background:
    linear-gradient(#fff,#fff) center/1px 100%,
    linear-gradient(#fff,#fff) center/100% 1px;
  background-repeat: no-repeat;
  opacity: 0.5;
}
</style>
</head>

<body>

<!-- UI -->
<div id="ui">
  <h3>Pixels remaining</h3>
  <div id="remaining">20</div>

  <h3>Color</h3>
  <input type="color" id="colorPicker" value="#ffffff">
  <div id="activeColor"></div>

  <button id="validate">Validate this mark</button>
</div>

<!-- Canvas -->
<div id="container">
  <canvas id="main" width="1000" height="1000"></canvas>
</div>

<!-- Loupe -->
<div id="loupe">
  <canvas id="zoom" width="140" height="140"></canvas>
</div>

<script>
/* ================= CONFIG ================= */
const SIZE = 1000;
const SCALE = 0.75;
let remaining = 20;
let currentColor = "#ffffff";

/* ================= CANVAS ================= */
const canvas = document.getElementById("main");
const ctx = canvas.getContext("2d");

const art = document.createElement("canvas");
art.width = SIZE;
art.height = SIZE;
const artCtx = art.getContext("2d");
artCtx.fillStyle = "#000";
artCtx.fillRect(0,0,SIZE,SIZE);

const locked = new Set();

/* ================= UI ================= */
const remainingEl = document.getElementById("remaining");
const picker = document.getElementById("colorPicker");
const activeColor = document.getElementById("activeColor");
const validateBtn = document.getElementById("validate");

activeColor.style.background = currentColor;

picker.addEventListener("input", e => {
  currentColor = e.target.value;
  activeColor.style.background = currentColor;
});

/* ================= LOUPE ================= */
const loupe = document.getElementById("loupe");
const zoom = document.getElementById("zoom");
const zoomCtx = zoom.getContext("2d");

/* ================= STATE ================= */
let mouseX = 0;
let mouseY = 0;
let insideCanvas = false;
let pendingPixel = null;
let pulse = null;

/* ================= MOUSE ================= */
window.addEventListener("mousemove", e => {
  mouseX = e.clientX;
  mouseY = e.clientY;

  const rect = canvas.getBoundingClientRect();
  insideCanvas =
    mouseX >= rect.left &&
    mouseX <= rect.right &&
    mouseY >= rect.top &&
    mouseY <= rect.bottom;

  if (insideCanvas) {
    loupe.style.display = "block";
    loupe.style.left = mouseX + 12 + "px";
    loupe.style.top = mouseY + 12 + "px";
  } else {
    loupe.style.display = "none";
  }
});

/* ================= CLICK ================= */
canvas.addEventListener("mousedown", e => {
  if (!insideCanvas || remaining <= 0) return;

  const rect = canvas.getBoundingClientRect();
  const x = Math.floor((e.clientX - rect.left) / SCALE);
  const y = Math.floor((e.clientY - rect.top) / SCALE);
  const key = `${x},${y}`;

  if (locked.has(key)) return;

  pendingPixel = { x, y, color: currentColor };
  validateBtn.classList.add("show");
});

/* ================= VALIDATE ================= */
validateBtn.addEventListener("click", () => {
  if (!pendingPixel) return;

  const { x, y, color } = pendingPixel;
  const key = `${x},${y}`;

  artCtx.fillStyle = color;
  artCtx.fillRect(x, y, 1, 1);
  locked.add(key);

  pulse = { x, y, t: 0 };
  pendingPixel = null;

  remaining--;
  remainingEl.textContent = remaining;
  remainingEl.classList.add("bump");
  setTimeout(() => remainingEl.classList.remove("bump"), 250);

  validateBtn.classList.remove("show");
});

/* ================= DRAW ================= */
function draw() {
  ctx.clearRect(0,0,SIZE,SIZE);
  ctx.drawImage(art,0,0);

  /* preview */
  if (pendingPixel) {
    ctx.fillStyle = pendingPixel.color;
    ctx.globalAlpha = 0.6;
    ctx.fillRect(pendingPixel.x, pendingPixel.y, 1, 1);
    ctx.globalAlpha = 1;
  }

  /* pulse */
  if (pulse) {
    pulse.t += 0.05;
    ctx.strokeStyle = `rgba(255,255,255,${1 - pulse.t})`;
    ctx.lineWidth = 1;
    ctx.strokeRect(
      pulse.x - pulse.t,
      pulse.y - pulse.t,
      1 + pulse.t * 2,
      1 + pulse.t * 2
    );
    if (pulse.t >= 1) pulse = null;
  }

  /* frame */
  ctx.strokeStyle = "rgba(255,255,255,0.8)";
  ctx.lineWidth = 1;
  ctx.strokeRect(0,0,SIZE,SIZE);
}

/* ================= LOOP ================= */
function loop() {
  draw();

  if (insideCanvas) {
    const rect = canvas.getBoundingClientRect();
    const cx = Math.floor((mouseX - rect.left) / SCALE);
    const cy = Math.floor((mouseY - rect.top) / SCALE);

    zoomCtx.imageSmoothingEnabled = false;
    zoomCtx.clearRect(0,0,140,140);
    zoomCtx.drawImage(
      art,
      cx - 10, cy - 10,
      20, 20,
      0, 0,
      140, 140
    );

    zoomCtx.strokeStyle = "rgba(255,255,255,0.8)";
    zoomCtx.lineWidth = 1;
    zoomCtx.strokeRect(0,0,140,140);
  }

  requestAnimationFrame(loop);
}

loop();
</script>

</body>
</html>
